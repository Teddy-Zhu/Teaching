function getSearchParams(a){var b=new Object();if(a!=undefined){b=a}$(".SearchForm").each(function(){var c=$(this).val();if(c==null&&c==undefined){c=""}else{c=c.trim()}b[$(this).attr("id")]=c});return b}function initUserType(d,a){var b=$.Deferred();var c=function(e){$("#"+d).empty();if(a!=undefined){$("#"+d).append('<option value="-1">全部</option>')}for(var f=0;len=e.length,f<len;f++){$("#"+d).append('<option value="'+e[f].intidentityid+'">'+e[f].strname+"</option>")}b.resolve()};if($("#datatable_perplaninfo").data("usertype")!=undefined){c($("#datatable_perplaninfo").data("usertype"))}else{$.ajax({url:"Type/GetUserTypeAll",dataType:"json",type:"post",success:function(e){$("#datatable_perplaninfo").data("usertype",e);c(e)},async:true})}return b.promise()}function initUserDepartMent(d,e,a){var f=e.toString().replace("-","minus");var b=$.Deferred();var c=function(g){$("#"+d).empty();if(a!=undefined){$("#"+d).append('<option value="-1">全部</option>')}for(var h=0;len=g.length,h<len;h++){$("#"+d).append('<option value="'+g[h].intid+'">'+g[h].strname+"</option>")}b.resolve()};if($("#datatable_perplaninfo").data("userdepartment"+f)!=undefined){c($("#datatable_perplaninfo").data("userdepartment"+f))}else{$.ajax({url:"Type/GetDepartMent",type:"post",dataType:"json",data:{id:e},success:function(g){$("#datatable_perplaninfo").data("userdepartment"+f,g);c(g)},async:true})}return b.promise()}function getDialogSearchParams(a){var b=new Object();if(a!=undefined){b=a}$(".DialogSearchForm").each(function(){var c=$(this).val();if(c==null&&c==undefined){c=""}else{c=c.trim()}b[$(this).attr("id")]=c});return b}function getPlanStatus(a){var b=$.Deferred();var c=function(d){for(var e=0;len=d.length,e<len;e++){$("#"+a).append('<option value="'+d[e].intplanstatusid+'">'+d[e].strmark+"</option>")}b.resolve()};if($("#PlanStatus").data("bookplanstatus")==undefined){$.ajax({url:"Plan/GetBookPlanStatus",dataType:"json",type:"post"}).success(function(d){$("#PlanStatus").data("bookplanstatus",d);c(d)})}else{c($("#PlanStatus").data("bookplanstatus"))}return b.promise()}function toolBarClick(g,c,d){var f=$("#datatable_perplaninfo").datagrid("getSelections");if(f.length<1){$.TeachDialog({content:"请至少选择一行!",bootstrapModalOption:{}});return}if(c){if(f.length>1){$.TeachDialog({content:"最多选择一行!",bootstrapModalOption:{}});return}}var e=new Array();for(var a=0,b=f.length;a<b;a++){e.push(f[a].intplanid);if(d&&f[a].bookPlanStatus.intplanstatusid!=1){$.TeachDialog({content:"你选择的计划状态不是审核中!",bootstrapModalOption:{}});return}}var h=undefined;switch(g){case 1:if(h==undefined){h="PassPlan"}case 2:if(h==undefined){h="RejectPlan"}case 3:if(h==undefined){h="RefusePlan"}$.ajax({url:"Plan/"+h,dataType:"json",type:"post",data:{planId:e}}).success(function(i){if(i){$.TeachDialog({content:"计划状态变更成功!",bootstrapModalOption:{}})}else{$.TeachDialog({content:"计划状态变更失败!",bootstrapModalOption:{}})}});break;case 4:h="ChangeStatus";LoadModel("changeplanstatusmodel").done(function(i){$.TeachDialog({title:"更改计划状态",content:i,otherButtons:["更改"],otherButtonStyles:["btn btn-primary"],dialogShow:function(){getPlanStatus("ChangePlanStatus")},clickButton:function(l,k,j){if(j==0){$.ajax({url:"Plan/"+h,dataType:"json",type:"post",data:{planId:e,Status:$("#ChangePlanStatus").val()}}).success(function(m){k.modal("hide");if(m){$.TeachDialog({content:"更改成功!"});$("#datatable_perplaninfo").datagrid("reload")}else{$.TeachDialog({content:"更改失败!"})}})}}})});break;case 5:$.TeachDialog({title:"计划历史",content:'<div id="historytable" class="table-responsive"><table class="table"><caption>计划历史记录</caption></table></div>',largeSize:true,dialogShow:function(){$.ajax({url:"Plan/GetPlanHistory",dataType:"json",type:"post",data:{PlanId:e[0]}}).success(function(k){$("#historytable table").append("<thead><tr><th>Id</th><th>操作</th><th>具体信息</th><th>操作人</th><th>操作时间</th></tr></thead><tbody></tbody>");for(var l=0,m=k.length;l<m;l++){var j="";if(k[l].bookPlanChange&&k[l].bookPlanChange.intbookchangeid!=-1){var n=k[l].bookPlanChange.intstudent;var o=k[l].bookPlanChange.intteacher;if(n!=0){j+=(n>0?"增加":"减少")+" 学生数 :"+Math.abs(n)+"<br>"}if(o!=0){j+=(o>0?"增加":"减少")+" 教师数 :"+Math.abs(o)+"<br>"}}else{j="none"}$("#historytable table tbody").append("<tr><td>"+(l+1)+"</td><td>"+k[l].operation.stroperationname+"</td><td>"+j.trimEnd("<br>")+"</td><td>"+k[l].user.strname+"</td><td>"+unix2human(k[l].datecreatetime)+"</td></tr>")}})}});break}}function queryPlanHistory(){$.TeachDialog({title:"计划信息",content:'<div id="historytable" class="table-responsive"><table class="table"><caption>计划历史信息</caption></table></div>',dialogShow:function(){$.ajax({url:"Plan/GetPerPlanHistory",dataType:"json",type:"post",data:{PlanId:planId}}).success(function(b){$("#historytable table").append("<thead><tr><th>Id</th><th>操作</th><th>具体信息</th><th>操作时间</th></tr></thead><tbody></tbody>");for(var c=0,d=b.length;c<d;c++){var a="";if(b[c].bookPlanChange&&b[c].bookPlanChange.intbookchangeid!=-1){var e=b[c].bookPlanChange.intstudent;var f=b[c].bookPlanChange.intteacher;if(e!=0){a+=(e>0?"增加":"减少")+" 学生数 :"+Math.abs(e)+"<br>"}if(f!=0){a+=(f>0?"增加":"减少")+" 教师数 :"+Math.abs(f)+"<br>"}}else{a="none"}$("#historytable table tbody").append("<tr><td>"+(c+1)+"</td><td>"+b[c].operation.stroperationname+"</td><td>"+a.trimEnd("<br>")+"</td><td>"+unix2human(b[c].datecreatetime)+"</td></tr>")}})}})}$(function(){console.log("aa");$("#SearchDate").datepicker({format:"yyyy-mm-dd",todayBtn:"linked",autoclose:true,todayHighlight:true,clearBtn:true});$.ajax({url:"Plan/GetCourseType",dataType:"json",type:"post"}).success(function(c){for(var d=0;len=c.length,d<len;d++){$("#CourseType").append('<option value="'+c[d].intcoursetypeid+'">'+c[d].strcoursename+"</option>")}});getPlanStatus("PlanStatus");var b=$("#datatable_perplaninfo").attr("data-size");if(b==undefined||b==""){b=10}cellwidth=($(".box-content.table-responsive").width()-55)/11;var a=$("#datatable_perplaninfo");a.datagrid({striped:true,remoteSort:false,fit:false,url:"Plan/GetAllPlan",loadMsg:"请等待数据载入.....",pagination:true,rownumbers:true,fitColumns:true,pageSize:b,pageList:[b,b*2,b*3,b*4,b*5],columns:[[{field:"strcoursename",title:"课程名",align:"center",sortable:true,width:cellwidth},{field:"courseType",title:"课程类型",align:"center",width:cellwidth,sortable:true,formatter:function(c){return c.strcoursename}},{field:"strclass",title:"班级",align:"center",width:cellwidth,sortable:true},{field:"intstudcount",title:"学生数",align:"center",width:cellwidth*0.5,sortable:true},{field:"intteaccount",title:"教师数",align:"center",width:cellwidth*0.5,sortable:true},{field:"book",title:"书名",align:"center",width:cellwidth*2,sortable:true,formatter:function(c){return c.strbookname}},{field:"intfromyear",title:"时间",align:"center",width:cellwidth,formatter:function(d,c){return d+"-"+c.inttoyear}},{field:"intterm",title:"学期",align:"center",width:cellwidth,sortable:true,formatter:function(c){if(c){return"下半学年"}else{return"上半学年"}}},{field:"user",title:"申请人",align:"center",width:cellwidth,formatter:function(c){return c.strname}},{field:"strmark",title:"备注",align:"center",width:cellwidth},{field:"datecreatetime",title:"申请时间",align:"center",width:cellwidth+35,sortable:true,formatter:function(c){return unix2human(c)}},{field:"bookPlanStatus",title:"状态",align:"center",width:cellwidth,sortable:true,formatter:function(c){return c.strmark}}]],onBeforeLoad:function(c){c=getSearchParams(c)},toolbar:[{text:"通过计划",iconCls:"fa fa-pencil",handler:function(){toolBarClick(1,false,true)}},"-",{text:"驳回计划",iconCls:"fa fa-remove",handler:function(){toolBarClick(2,false,true)}},"-",{text:"拒绝计划",iconCls:"fa fa-recycle",handler:function(){toolBarClick(3,false,true)}},"-",{text:"更改为其他状态",iconCls:"fa fa-search",handler:function(){toolBarClick(4,false,false)}},"-",{text:"查询历史",iconCls:"fa fa-search",handler:function(){toolBarClick(5,true,false)}},"-",{text:"导出下方所有数据到Excel",iconCls:"fa fa-download",handler:function(){$.DownloadFile({url:"Plan/ExportPerPlan",method:"post",data:getSearchParams()})}},"-",{text:"按班级导出数据统计到Excel",iconCls:"fa fa-download",handler:function(){$.DownloadFile({url:"Plan/ExportAllPlanByClasses",method:"post",data:getSearchParams()})}}],onClickRow:function(d,c){$("#notification").html('<strong class="col-xs-3">单价:'+c.book.strprice.toFixed(2)+'</strong><strong class="col-xs-3">折扣:'+c.book.intpricediscount.toFixed(2)+'</strong><strong class="col-xs-3">学生总计:'+(c.intstudcount*c.book.strprice*c.book.intpricediscount/10).toFixed(2)+'</strong><strong class="col-xs-3">教师总计:'+(c.intteaccount*c.book.strprice*c.book.intpricediscount/10).toFixed(2)+"</strong>")},onLoadSuccess:function(c){$("#notification").html("未选择计划")}});$("#userselect").click(function(){LoadModel("selectusermodel").done(function(c){$.TeachDialog({modalID:"SelectUsersModal",title:"从表中选择用户",content:c,largeSize:true,otherButtons:["清除","选择"],otherButtonStyles:["btn btn-primary"],clickButton:function(g,e,d){if(d==1){var f=$("#datatable_userinfo").datagrid("getSelections");if(f.length!=1){$.TeachDialog({content:"请至少选择一行!",bootstrapModalOption:{}});return}else{$("#UserId").empty();$("#UserId").append('<option value="'+f[0].intid+'">'+f[0].strname+"</option>")}}else{if(d==0){$("#UserId").empty()}}e.modal("hide")},dialogHide:function(){},dialogShown:function(){$("#SearchTime").datepicker({format:"yyyy-mm-dd",todayBtn:"linked",autoclose:true,todayHighlight:true,clearBtn:true});initUserType("SearchUserType",true);initUserDepartMent("SearchDepartMent",1,true).done(function(){$("#SearchDepartMent").change(function(){initUserDepartMent("SearchMajor",$("#SearchDepartMent").val(),true)});initUserDepartMent("SearchMajor",$("#SearchDepartMent").val(),true)});var d=($(".modal-body").width()-55)/11;$("#datatable_userinfo").datagrid({striped:true,remoteSort:false,collapsible:true,fit:false,url:"User/GetAllUser",loadMsg:"请等待数据载入.....",pagination:true,rownumbers:true,singleSelect:true,fitColumns:true,columns:[[{field:"intid",title:"用户ID",align:"center",sortable:true,width:d*0.5},{field:"username",title:"用户名",align:"center",sortable:true,width:d},{field:"strname",title:"姓名",align:"center",width:d,sortable:true},{field:"userType",title:"用户组",align:"center",width:d,sortable:true,formatter:function(e){return e.strname}},{field:"userDepartMent",title:"系部",align:"center",width:d,sortable:true,formatter:function(e){return e.strname}},{field:"userMajor",title:"专业",align:"center",width:d*1.4,sortable:true,formatter:function(e){return e.strname}},{field:"strstunum",title:"学号",align:"center",width:d,sortable:true},{field:"strphone",title:"手机",align:"center",width:d,sortable:true},{field:"strmail",title:"邮箱",align:"center",width:d,sortable:true},{field:"dateregtime",title:"创建时间",align:"center",width:d*1.1+10,sortable:true,formatter:function(e){return unix2human(e)}}]],onBeforeLoad:function(e){e=getDialogSearchParams(e)},onDblClickRow:function(f,e){$("#UserId").empty();$("#UserId").append('<option value="'+e.intid+'">'+e.strname+"</option>");$("#SelectUsersModal").modal("hide")}});$("#DialogSearch").click(function(){$("#datatable_userinfo").datagrid("reload")})}})})});$("#Search").click(function(){a.datagrid("reload")})});