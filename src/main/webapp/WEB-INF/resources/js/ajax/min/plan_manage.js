function getSearchParams(params){var searchParams=new Object;return void 0!=params&&(searchParams=params),$(".SearchForm").each(function(){var param=$(this).val();param=null==param&&void 0==param?"":param.trim(),searchParams[$(this).attr("id")]=param}),searchParams}function initUserType(id,addition){var dtd=$.Deferred(),fillDom=function(domData){$("#"+id).empty(),void 0!=addition&&$("#"+id).append('<option value="-1">All UserType</option>');for(var i=0;len=domData.length,i<len;i++)$("#"+id).append('<option value="'+domData[i].intidentityid+'">'+domData[i].strname+"</option>");dtd.resolve()};return void 0!=$("#datatable_perplaninfo").data("usertype")?fillDom($("#datatable_perplaninfo").data("usertype")):$.ajax({url:"Type/GetUserTypeAll",dataType:"json",type:"post",success:function(data){$("#datatable_perplaninfo").data("usertype",data),fillDom(data)},async:!0}),dtd.promise()}function initUserDepartMent(id,type,addition){var typedata=type.toString().replace("-","minus"),dtd=$.Deferred(),filldom=function(domData){$("#"+id).empty(),void 0!=addition&&$("#"+id).append('<option value="-1">All DepartMent</option>');for(var i=0;len=domData.length,i<len;i++)$("#"+id).append('<option value="'+domData[i].intid+'">'+domData[i].strname+"</option>");dtd.resolve()};return void 0!=$("#datatable_perplaninfo").data("userdepartment"+typedata)?filldom($("#datatable_perplaninfo").data("userdepartment"+typedata)):$.ajax({url:"Type/GetDepartMent",type:"post",dataType:"json",data:{id:type},success:function(data){$("#datatable_perplaninfo").data("userdepartment"+typedata,data),filldom(data)},async:!0}),dtd.promise()}function getDialogSearchParams(params){var searchParams=new Object;return void 0!=params&&(searchParams=params),$(".DialogSearchForm").each(function(){var param=$(this).val();param=null==param&&void 0==param?"":param.trim(),searchParams[$(this).attr("id")]=param}),searchParams}function getPlanStatus(domId){var dtd=$.Deferred(),fillDom=function(domData){for(var i=0;len=domData.length,i<len;i++)$("#"+domId).append('<option value="'+domData[i].intplanstatusid+'">'+domData[i].strmark+"</option>");dtd.resolve()};return void 0==$("#PlanStatus").data("bookplanstatus")?$.ajax({url:"Plan/GetBookPlanStatus",dataType:"json",type:"post"}).success(function(data){$("#PlanStatus").data("bookplanstatus",data),fillDom(data)}):fillDom($("#PlanStatus").data("bookplanstatus")),dtd.promise()}function toolBarClick(type,oneneed,pendingneed){var plans,i,len,url,rows=$("#datatable_perplaninfo").datagrid("getSelections");if(rows.length<1)return void $.TeachDialog({content:"You should select one row at least!",bootstrapModalOption:{}});if(oneneed&&rows.length>1)return void $.TeachDialog({content:"You should select one row at most!",bootstrapModalOption:{}});for(plans=new Array,i=0,len=rows.length;len>i;i++)if(plans.push(rows[i].intplanid),pendingneed&&1!=rows[i].bookPlanStatus.intplanstatusid)return void $.TeachDialog({content:"The plan status you selected is not pending!",bootstrapModalOption:{}});switch(url=void 0,type){case 1:void 0==url&&(url="PassPlan");case 2:void 0==url&&(url="RejectPlan");case 3:void 0==url&&(url="RefusePlan"),$.ajax({url:"Plan/"+url,dataType:"json",type:"post",data:{planId:plans}}).success(function(data){$.TeachDialog(data?{content:"Change Plan Status Successfully!",bootstrapModalOption:{}}:{content:"Change Plan Status failed!",bootstrapModalOption:{}})});break;case 4:url="ChangeStatus",LoadModel("changeplanstatusmodel").done(function(responseContent){$.TeachDialog({title:"Change The Plan Status",content:responseContent,otherButtons:["Change"],otherButtonStyles:["btn btn-primary"],dialogShow:function(){getPlanStatus("ChangePlanStatus")},clickButton:function(sender,modal,index){0==index&&$.ajax({url:"Plan/"+url,dataType:"json",type:"post",data:{planId:plans,Status:$("#ChangePlanStatus").val()}}).success(function(data){modal.modal("hide"),data?($.TeachDialog({content:"Change Plans Status Success!"}),$("#datatable_perplaninfo").datagrid("reload")):$.TeachDialog({content:"Change Plans Status failed!"})})}})});break;case 5:$.TeachDialog({title:"The Plan History",content:'<div id="historytable" class="table-responsive"><table class="table"><caption>Plan Histroy Changes</caption></table></div>',largeSize:!0,dialogShow:function(){$.ajax({url:"Plan/GetPlanHistory",dataType:"json",type:"post",data:{PlanId:plans[0]}}).success(function(data){var i,len,changeString,stcount,teacount;for($("#historytable table").append("<thead><tr><th>Id</th><th>Operation Name</th><th>Changes</th><th>Operation Personal</th><th>Operation Time</th></tr></thead><tbody></tbody>"),i=0,len=data.length;len>i;i++)changeString="",data[i].bookPlanChange&&-1!=data[i].bookPlanChange.intbookchangeid?(stcount=data[i].bookPlanChange.intstudent,teacount=data[i].bookPlanChange.intteacher,0!=stcount&&(changeString+=(stcount>0?"Increase":"Decrease")+" Student Number :"+Math.abs(stcount)+"<br>"),0!=teacount&&(changeString+=(teacount>0?"Increase":"Decrease")+" Teacher Number :"+Math.abs(teacount)+"<br>")):changeString="none",$("#historytable table tbody").append("<tr><td>"+(i+1)+"</td><td>"+data[i].operation.stroperationname+"</td><td>"+changeString.trimEnd("<br>")+"</td><td>"+data[i].user.strname+"</td><td>"+unix2human(data[i].datecreatetime)+"</td></tr>")})}})}}function queryPlanHistory(){$.TeachDialog({title:"The Plan History",content:'<div id="historytable" class="table-responsive"><table class="table"><caption>Plan Histroy Changes</caption></table></div>',dialogShow:function(){$.ajax({url:"Plan/GetPerPlanHistory",dataType:"json",type:"post",data:{PlanId:planId}}).success(function(data){var i,len,changeString,stcount,teacount;for($("#historytable table").append("<thead><tr><th>Id</th><th>Operation Name</th><th>Changes</th><th>Operation Time</th></tr></thead><tbody></tbody>"),i=0,len=data.length;len>i;i++)changeString="",data[i].bookPlanChange&&-1!=data[i].bookPlanChange.intbookchangeid?(stcount=data[i].bookPlanChange.intstudent,teacount=data[i].bookPlanChange.intteacher,0!=stcount&&(changeString+=(stcount>0?"Increase":"Decrease")+" Student Number :"+Math.abs(stcount)+"<br>"),0!=teacount&&(changeString+=(teacount>0?"Increase":"Decrease")+" Teacher Number :"+Math.abs(teacount)+"<br>")):changeString="none",$("#historytable table tbody").append("<tr><td>"+(i+1)+"</td><td>"+data[i].operation.stroperationname+"</td><td>"+changeString.trimEnd("<br>")+"</td><td>"+unix2human(data[i].datecreatetime)+"</td></tr>")})}})}$(function(){var psval,$mydatagrid;$("#SearchDate").datepicker({format:"yyyy-mm-dd",todayBtn:"linked",autoclose:!0,todayHighlight:!0,clearBtn:!0}),$.ajax({url:"Plan/GetCourseType",dataType:"json",type:"post"}).success(function(data){for(var i=0;len=data.length,i<len;i++)$("#CourseType").append('<option value="'+data[i].intcoursetypeid+'">'+data[i].strcoursename+"</option>")}),getPlanStatus("PlanStatus"),psval=$("#datatable_perplaninfo").attr("data-size"),(void 0==psval||""==psval)&&(psval=10),cellwidth=($(".box-content.table-responsive").width()-55)/11,$mydatagrid=$("#datatable_perplaninfo"),$mydatagrid.datagrid({striped:!0,remoteSort:!1,fit:!1,url:"Plan/GetAllPlan",loadMsg:"Please waiting for loading date.....",pagination:!0,rownumbers:!0,fitColumns:!0,pageSize:psval,pageList:[psval,2*psval,3*psval,4*psval,5*psval],columns:[[{field:"strcoursename",title:"CourseName",align:"center",sortable:!0,width:cellwidth},{field:"courseType",title:"CourseType",align:"center",width:cellwidth,sortable:!0,formatter:function(value){return value.strcoursename}},{field:"strclass",title:"ClassId",align:"center",width:cellwidth,sortable:!0},{field:"intstudcount",title:"Student Count",align:"center",width:.5*cellwidth,sortable:!0},{field:"intteaccount",title:"Teacher Count",align:"center",width:.5*cellwidth,sortable:!0},{field:"book",title:"BookName",align:"center",width:2*cellwidth,sortable:!0,formatter:function(value){return value.strbookname}},{field:"intfromyear",title:"Time",align:"center",width:cellwidth,formatter:function(value,row){return value+"-"+row.inttoyear}},{field:"intterm",title:"Term",align:"center",width:cellwidth,sortable:!0,formatter:function(value){return value?"下半学年":"上半学年"}},{field:"user",title:"Applicant",align:"center",width:cellwidth,formatter:function(value){return value.strname}},{field:"strmark",title:"Mark",align:"center",width:cellwidth},{field:"datecreatetime",title:"CreateTime",align:"center",width:cellwidth+35,sortable:!0,formatter:function(value){return unix2human(value)}},{field:"bookPlanStatus",title:"Status",align:"center",width:cellwidth,sortable:!0,formatter:function(value){return value.strmark}}]],onBeforeLoad:function(param){param=getSearchParams(param)},toolbar:[{text:"Pass Plan",iconCls:"fa fa-pencil",handler:function(){toolBarClick(1,!1,!0)}},"-",{text:"Reject Plan",iconCls:"fa fa-remove",handler:function(){toolBarClick(2,!1,!0)}},"-",{text:"Refuse Plan",iconCls:"fa fa-recycle",handler:function(){toolBarClick(3,!1,!0)}},"-",{text:"Change Other Status",iconCls:"fa fa-search",handler:function(){toolBarClick(4,!1,!1)}},"-",{text:"Query Plan History",iconCls:"fa fa-search",handler:function(){toolBarClick(5,!0,!1)}},"-",{text:"Export Below Plan To Excel",iconCls:"fa fa-download",handler:function(){$.DownloadFile({url:"Plan/ExportPerPlan",method:"post",data:getSearchParams()})}},"-",{text:"Export Below Plan Statistics To Excel",iconCls:"fa fa-download",handler:function(){$.DownloadFile({url:"Plan/ExportAllPlanByClasses",method:"post",data:getSearchParams()})}}],onClickRow:function(rowIndex,rowData){$("#notification").html('<strong class="col-xs-3">Unit Price:'+rowData.book.strprice.toFixed(2)+'</strong><strong class="col-xs-3">Discount:'+rowData.book.intpricediscount.toFixed(2)+'</strong><strong class="col-xs-3">Student Total:'+(rowData.intstudcount*rowData.book.strprice*rowData.book.intpricediscount/10).toFixed(2)+'</strong><strong class="col-xs-3">Teacher Total:'+(rowData.intteaccount*rowData.book.strprice*rowData.book.intpricediscount/10).toFixed(2)+"</strong>")},onLoadSuccess:function(data){$("#notification").html("No Selected Plan")}}),$("#userselect").click(function(){LoadModel("selectusermodel").done(function(responseContent){$.TeachDialog({modalID:"SelectUsersModal",title:"Select Users From Table",content:responseContent,largeSize:!0,otherButtons:["Clear","Select"],otherButtonStyles:["btn btn-primary"],clickButton:function(sender,modal,index){if(1==index){var rows=$("#datatable_userinfo").datagrid("getSelections");if(1!=rows.length)return void $.TeachDialog({content:"You should select a row!",bootstrapModalOption:{}});$("#UserId").empty(),$("#UserId").append('<option value="'+rows[0].intid+'">'+rows[0].strname+"</option>")}else 0==index&&$("#UserId").empty();modal.modal("hide")},dialogHide:function(){},dialogShown:function(){initUserType("SearchUserType",!0),initUserDepartMent("SearchDepartMent",1,!0).done(function(){$("#SearchDepartMent").change(function(){initUserDepartMent("SearchMajor",$("#SearchDepartMent").val(),!0)}),initUserDepartMent("SearchMajor",$("#SearchDepartMent").val(),!0)}),$("#DialogSearch").click(function(){$("#datatable_userinfo").datagrid("reload")}),$("#SearchTime").datepicker({format:"yyyy-mm-dd",todayBtn:"linked",autoclose:!0,todayHighlight:!0,clearBtn:!0});var cellwidth=($(".modal-body").width()-55)/11;$("#datatable_userinfo").datagrid({striped:!0,remoteSort:!1,collapsible:!0,fit:!1,url:"User/GetAllUser",loadMsg:"Please waiting for loading date.....",pagination:!0,rownumbers:!0,singleSelect:!0,fitColumns:!0,columns:[[{field:"intid",title:"User ID",align:"center",sortable:!0,width:.5*cellwidth},{field:"username",title:"UserName",align:"center",sortable:!0,width:cellwidth},{field:"strname",title:"RealName",align:"center",width:cellwidth,sortable:!0},{field:"userType",title:"UserType",align:"center",width:cellwidth,sortable:!0,formatter:function(value){return value.strname}},{field:"userDepartMent",title:"DepartMent",align:"center",width:cellwidth,sortable:!0,formatter:function(value){return value.strname}},{field:"userMajor",title:"Major",align:"center",width:1.4*cellwidth,sortable:!0,formatter:function(value){return value.strname}},{field:"strstunum",title:"Id Card",align:"center",width:cellwidth,sortable:!0},{field:"strphone",title:"Phone",align:"center",width:cellwidth,sortable:!0},{field:"strmail",title:"Email",align:"center",width:cellwidth,sortable:!0},{field:"dateregtime",title:"CreateTime",align:"center",width:1.1*cellwidth+10,sortable:!0,formatter:function(value){return unix2human(value)}}]],onBeforeLoad:function(param){param=getDialogSearchParams(param)},onDblClickRow:function(rowIndex,rowData){$("#UserId").empty(),$("#UserId").append('<option value="'+rowData.intid+'">'+rowData.strname+"</option>"),$("#SelectUsersModal").modal("hide")}})}})})}),$("#Search").click(function(){$mydatagrid.datagrid("reload")})});