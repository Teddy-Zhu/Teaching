function getSearchParams(t){var e=new Object;return void 0!=t&&(e=t),$(".SearchForm").each(function(){var t=$(this).val();t=null==t&&void 0==t?"":t.trim(),e[$(this).attr("id")]=t}),e}function initUserType(t,e){var a=$.Deferred(),n=function(n){$("#"+t).empty(),void 0!=e&&$("#"+t).append('<option value="-1">全部</option>');for(var o=0;len=n.length,o<len;o++)$("#"+t).append('<option value="'+n[o].intidentityid+'">'+n[o].strname+"</option>");a.resolve()};return void 0!=$("#datatable_perplaninfo").data("usertype")?n($("#datatable_perplaninfo").data("usertype")):$.ajax({url:"Type/GetUserTypeAll",dataType:"json",type:"post",success:function(t){$("#datatable_perplaninfo").data("usertype",t),n(t)},async:!0}),a.promise()}function initUserDepartMent(t,e,a){var n=e.toString().replace("-","minus"),o=$.Deferred(),i=function(e){$("#"+t).empty(),void 0!=a&&$("#"+t).append('<option value="-1">全部</option>');for(var n=0;len=e.length,n<len;n++)$("#"+t).append('<option value="'+e[n].intid+'">'+e[n].strname+"</option>");o.resolve()};return void 0!=$("#datatable_perplaninfo").data("userdepartment"+n)?i($("#datatable_perplaninfo").data("userdepartment"+n)):$.ajax({url:"Type/GetDepartMent",type:"post",dataType:"json",data:{id:e},success:function(t){$("#datatable_perplaninfo").data("userdepartment"+n,t),i(t)},async:!0}),o.promise()}function getDialogSearchParams(t){var e=new Object;return void 0!=t&&(e=t),$(".DialogSearchForm").each(function(){var t=$(this).val();t=null==t&&void 0==t?"":t.trim(),e[$(this).attr("id")]=t}),e}function getPlanStatus(t){var e=$.Deferred(),a=function(a){for(var n=0;len=a.length,n<len;n++)$("#"+t).append('<option value="'+a[n].intplanstatusid+'">'+a[n].strmark+"</option>");e.resolve()};return void 0==$("#PlanStatus").data("bookplanstatus")?$.ajax({url:"Plan/GetBookPlanStatus",dataType:"json",type:"post"}).success(function(t){$("#PlanStatus").data("bookplanstatus",t),a(t)}):a($("#PlanStatus").data("bookplanstatus")),e.promise()}function toolBarClick(t,e,a){var n,o,i,r,l=$("#datatable_perplaninfo").datagrid("getSelections");if(l.length<1)return void $.TeachDialog({content:"请至少选择一行!",bootstrapModalOption:{}});if(e&&l.length>1)return void $.TeachDialog({content:"最多选择一行!",bootstrapModalOption:{}});for(n=new Array,o=0,i=l.length;i>o;o++)if(n.push(l[o].intplanid),a&&1!=l[o].bookPlanStatus.intplanstatusid)return void $.TeachDialog({content:"你选择的计划状态不是审核中!",bootstrapModalOption:{}});switch(r=void 0,t){case 1:void 0==r&&(r="PassPlan");case 2:void 0==r&&(r="RejectPlan");case 3:void 0==r&&(r="RefusePlan"),$.ajax({url:"Plan/"+r,dataType:"json",type:"post",data:{planId:n}}).success(function(t){$.TeachDialog(t?{content:"计划状态变更成功!",bootstrapModalOption:{}}:{content:"计划状态变更失败!",bootstrapModalOption:{}})});break;case 4:r="ChangeStatus",LoadModel("changeplanstatusmodel").done(function(t){$.TeachDialog({title:"更改计划状态",content:t,otherButtons:["更改"],otherButtonStyles:["btn btn-primary"],dialogShow:function(){getPlanStatus("ChangePlanStatus")},clickButton:function(t,e,a){0==a&&$.ajax({url:"Plan/"+r,dataType:"json",type:"post",data:{planId:n,Status:$("#ChangePlanStatus").val()}}).success(function(t){e.modal("hide"),t?($.TeachDialog({content:"更改成功!"}),$("#datatable_perplaninfo").datagrid("reload")):$.TeachDialog({content:"更改失败!"})})}})});break;case 5:$.TeachDialog({title:"计划历史",content:'<div id="historytable" class="table-responsive"><table class="table"><caption>计划历史记录</caption></table></div>',largeSize:!0,dialogShow:function(){$.ajax({url:"Plan/GetPlanHistory",dataType:"json",type:"post",data:{PlanId:n[0]}}).success(function(t){var e,a,n,o,i;for($("#historytable table").append("<thead><tr><th>Id</th><th>操作</th><th>具体信息</th><th>操作人</th><th>操作时间</th></tr></thead><tbody></tbody>"),e=0,a=t.length;a>e;e++)n="",t[e].bookPlanChange&&-1!=t[e].bookPlanChange.intbookchangeid?(o=t[e].bookPlanChange.intstudent,i=t[e].bookPlanChange.intteacher,0!=o&&(n+=(o>0?"增加":"减少")+" 学生数 :"+Math.abs(o)+"<br>"),0!=i&&(n+=(i>0?"增加":"减少")+" 教师数 :"+Math.abs(i)+"<br>")):n="none",$("#historytable table tbody").append("<tr><td>"+(e+1)+"</td><td>"+t[e].operation.stroperationname+"</td><td>"+n.trimEnd("<br>")+"</td><td>"+t[e].user.strname+"</td><td>"+unix2human(t[e].datecreatetime)+"</td></tr>")})}})}}function queryPlanHistory(){$.TeachDialog({title:"计划信息",content:'<div id="historytable" class="table-responsive"><table class="table"><caption>计划历史信息</caption></table></div>',dialogShow:function(){$.ajax({url:"Plan/GetPerPlanHistory",dataType:"json",type:"post",data:{PlanId:planId}}).success(function(t){var e,a,n,o,i;for($("#historytable table").append("<thead><tr><th>Id</th><th>操作</th><th>具体信息</th><th>操作时间</th></tr></thead><tbody></tbody>"),e=0,a=t.length;a>e;e++)n="",t[e].bookPlanChange&&-1!=t[e].bookPlanChange.intbookchangeid?(o=t[e].bookPlanChange.intstudent,i=t[e].bookPlanChange.intteacher,0!=o&&(n+=(o>0?"增加":"减少")+" 学生数 :"+Math.abs(o)+"<br>"),0!=i&&(n+=(i>0?"增加":"减少")+" 教师数 :"+Math.abs(i)+"<br>")):n="none",$("#historytable table tbody").append("<tr><td>"+(e+1)+"</td><td>"+t[e].operation.stroperationname+"</td><td>"+n.trimEnd("<br>")+"</td><td>"+unix2human(t[e].datecreatetime)+"</td></tr>")})}})}$(function(){var t,e;console.log("aa"),$("#SearchDate").datepicker({format:"yyyy-mm-dd",todayBtn:"linked",autoclose:!0,todayHighlight:!0,clearBtn:!0}),$.ajax({url:"Plan/GetCourseType",dataType:"json",type:"post"}).success(function(t){for(var e=0;len=t.length,e<len;e++)$("#CourseType").append('<option value="'+t[e].intcoursetypeid+'">'+t[e].strcoursename+"</option>")}),getPlanStatus("PlanStatus"),t=$("#datatable_perplaninfo").attr("data-size"),(void 0==t||""==t)&&(t=10),cellwidth=($(".box-content.table-responsive").width()-55)/11,e=$("#datatable_perplaninfo"),e.datagrid({striped:!0,remoteSort:!1,fit:!1,url:"Plan/GetAllPlan",loadMsg:"请等待数据载入.....",pagination:!0,rownumbers:!0,fitColumns:!0,pageSize:t,pageList:[t,2*t,3*t,4*t,5*t],columns:[[{field:"strcoursename",title:"课程名",align:"center",sortable:!0,width:cellwidth},{field:"courseType",title:"课程类型",align:"center",width:cellwidth,sortable:!0,formatter:function(t){return t.strcoursename}},{field:"strclass",title:"班级",align:"center",width:cellwidth,sortable:!0},{field:"intstudcount",title:"学生数",align:"center",width:.5*cellwidth,sortable:!0},{field:"intteaccount",title:"教师数",align:"center",width:.5*cellwidth,sortable:!0},{field:"book",title:"书名",align:"center",width:2*cellwidth,sortable:!0,formatter:function(t){return t.strbookname}},{field:"intfromyear",title:"时间",align:"center",width:cellwidth,formatter:function(t,e){return t+"-"+e.inttoyear}},{field:"intterm",title:"学期",align:"center",width:cellwidth,sortable:!0,formatter:function(t){return t?"下半学年":"上半学年"}},{field:"user",title:"申请人",align:"center",width:cellwidth,formatter:function(t){return t.strname}},{field:"strmark",title:"备注",align:"center",width:cellwidth},{field:"datecreatetime",title:"申请时间",align:"center",width:cellwidth+35,sortable:!0,formatter:function(t){return unix2human(t)}},{field:"bookPlanStatus",title:"状态",align:"center",width:cellwidth,sortable:!0,formatter:function(t){return t.strmark}}]],onBeforeLoad:function(t){t=getSearchParams(t)},toolbar:[{text:"通过计划",iconCls:"fa fa-pencil",handler:function(){toolBarClick(1,!1,!0)}},"-",{text:"驳回计划",iconCls:"fa fa-remove",handler:function(){toolBarClick(2,!1,!0)}},"-",{text:"拒绝计划",iconCls:"fa fa-recycle",handler:function(){toolBarClick(3,!1,!0)}},"-",{text:"更改为其他状态",iconCls:"fa fa-search",handler:function(){toolBarClick(4,!1,!1)}},"-",{text:"查询历史",iconCls:"fa fa-search",handler:function(){toolBarClick(5,!0,!1)}},"-",{text:"导出下方所有数据到Excel",iconCls:"fa fa-download",handler:function(){$.DownloadFile({url:"Plan/ExportPerPlan",method:"post",data:getSearchParams()})}},"-",{text:"按班级导出数据统计到Excel",iconCls:"fa fa-download",handler:function(){$.DownloadFile({url:"Plan/ExportAllPlanByClasses",method:"post",data:getSearchParams()})}}],onClickRow:function(t,e){$("#notification").html('<strong class="col-xs-3">单价:'+e.book.strprice.toFixed(2)+'</strong><strong class="col-xs-3">折扣:'+e.book.intpricediscount.toFixed(2)+'</strong><strong class="col-xs-3">学生总计:'+(e.intstudcount*e.book.strprice*e.book.intpricediscount/10).toFixed(2)+'</strong><strong class="col-xs-3">教师总计:'+(e.intteaccount*e.book.strprice*e.book.intpricediscount/10).toFixed(2)+"</strong>")},onLoadSuccess:function(t){$("#notification").html("未选择计划")}}),$("#userselect").click(function(){LoadModel("selectusermodel").done(function(t){$.TeachDialog({modalID:"SelectUsersModal",title:"从表中选择用户",content:t,largeSize:!0,otherButtons:["清除","选择"],otherButtonStyles:["btn btn-primary"],clickButton:function(t,e,a){if(1==a){var n=$("#datatable_userinfo").datagrid("getSelections");if(1!=n.length)return void $.TeachDialog({content:"请至少选择一行!",bootstrapModalOption:{}});$("#UserId").empty(),$("#UserId").append('<option value="'+n[0].intid+'">'+n[0].strname+"</option>")}else 0==a&&$("#UserId").empty();e.modal("hide")},dialogHide:function(){},dialogShown:function(){$("#SearchTime").datepicker({format:"yyyy-mm-dd",todayBtn:"linked",autoclose:!0,todayHighlight:!0,clearBtn:!0}),initUserType("SearchUserType",!0),initUserDepartMent("SearchDepartMent",1,!0).done(function(){$("#SearchDepartMent").change(function(){initUserDepartMent("SearchMajor",$("#SearchDepartMent").val(),!0)}),initUserDepartMent("SearchMajor",$("#SearchDepartMent").val(),!0)});var t=($(".modal-body").width()-55)/11;$("#datatable_userinfo").datagrid({striped:!0,remoteSort:!1,collapsible:!0,fit:!1,url:"User/GetAllUser",loadMsg:"请等待数据载入.....",pagination:!0,rownumbers:!0,singleSelect:!0,fitColumns:!0,columns:[[{field:"intid",title:"用户ID",align:"center",sortable:!0,width:.5*t},{field:"username",title:"用户名",align:"center",sortable:!0,width:t},{field:"strname",title:"姓名",align:"center",width:t,sortable:!0},{field:"userType",title:"用户组",align:"center",width:t,sortable:!0,formatter:function(t){return t.strname}},{field:"userDepartMent",title:"系部",align:"center",width:t,sortable:!0,formatter:function(t){return t.strname}},{field:"userMajor",title:"专业",align:"center",width:1.4*t,sortable:!0,formatter:function(t){return t.strname}},{field:"strstunum",title:"学号",align:"center",width:t,sortable:!0},{field:"strphone",title:"手机",align:"center",width:t,sortable:!0},{field:"strmail",title:"邮箱",align:"center",width:t,sortable:!0},{field:"dateregtime",title:"创建时间",align:"center",width:1.1*t+10,sortable:!0,formatter:function(t){return unix2human(t)}}]],onBeforeLoad:function(t){t=getDialogSearchParams(t)},onDblClickRow:function(t,e){$("#UserId").empty(),$("#UserId").append('<option value="'+e.intid+'">'+e.strname+"</option>"),$("#SelectUsersModal").modal("hide")}}),$("#DialogSearch").click(function(){$("#datatable_userinfo").datagrid("reload")})}})})}),$("#Search").click(function(){e.datagrid("reload")})});