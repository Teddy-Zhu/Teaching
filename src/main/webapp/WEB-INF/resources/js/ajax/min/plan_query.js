function getSearchParams(t){var a=new Object;return void 0!=t&&(a=t),$(".SearchForm").each(function(){var t=$(this).val().trim();void 0==t&&(t=""),a[$(this).attr("id")]=t}),a}function toolBarClick(t){var a,e=$("#datatable_perplaninfo").datagrid("getSelections");if(1!=e.length)return void $.TeachDialog({content:"你最多可以选择一行!",bootstrapModalOption:{}});switch(a=e[0].intplanid,t){case 1:if(e[0].bookPlanStatus.intplanstatusid>2)return void $.TeachDialog({content:"这个计划的状态不能被改变，因为它的状态是 "+e[0].bookPlanStatus.strmark+"!",bootstrapModalOption:{}});LoadModel("changeplandetailmodel").done(function(t){$.TeachDialog({title:"更改计划",content:t,otherButtons:["确认"],otherButtonStyles:["btn btn-primary"],dialogShow:function(){$("#StuChange,#TeaChange").TouchSpin({min:-100,max:100,step:1})},clickButton:function(t,e,n){if(0==n){if("0"==$("#StuChange").val()&&"0"==$("#TeaChange").val()||""==$("#StuChange").val().trim()||""==$("#TeaChange").val().trim())return void $.TeachDialog({content:"参数错误!"});$.ajax({url:"Plan/Change",dataType:"json",type:"post",data:{StuChange:$("#StuChange").val(),TeaChange:$("#TeaChange").val(),ChangeReason:$("#ChangeReason").val(),PlanId:a}}).success(function(t){t?($.TeachDialog({content:"更改成功!"}),e.modal("hide"),$("#datatable_perplaninfo").datagrid("reload")):$.TeachDialog({content:"更改失败!"})})}}})});break;case 2:if(e[0].bookPlanStatus.intplanstatusid>2)return void $.TeachDialog({content:"这个计划不能被取消，因为它的状态是 "+e[0].bookPlanStatus.strmark+"!",bootstrapModalOption:{}});$.ajax({url:"Plan/Cancel",dataType:"json",type:"post",data:{PlanId:a}}).success(function(t){t&&($.TeachDialog({content:"计划已经取消",bootstrapModalOption:{}}),$("#datatable_perplaninfo").datagrid("reload"))});break;case 3:if(2!=e[0].bookPlanStatus.intplanstatusid)return void $.TeachDialog({content:"计划不能被再次提交，因为它的计划状态是 "+e[0].bookPlanStatus.strmark+"!",bootstrapModalOption:{}});$.ajax({url:"Plan/ReSubmit",dataType:"json",type:"post",data:{PlanId:a}}).success(function(t){t&&($.TeachDialog({content:"The Plan has been canceled!",bootstrapModalOption:{}}),$("#datatable_perplaninfo").datagrid("reload"))});break;case 4:$.TeachDialog({title:"计划历史",content:'<div id="historytable" class="table-responsive"><table class="table"><caption>计划历史变化</caption></table></div>',dialogShow:function(){$.ajax({url:"Plan/GetPerPlanHistory",dataType:"json",type:"post",data:{PlanId:a}}).success(function(t){var a,e,n,o,l;for($("#historytable table").append("<thead><tr><th>Id</th><th>操作</th><th>变更</th><th>操作时间</th></tr></thead><tbody></tbody>"),a=0,e=t.length;e>a;a++)n="",t[a].bookPlanChange&&-1!=t[a].bookPlanChange.intbookchangeid?(o=t[a].bookPlanChange.intstudent,l=t[a].bookPlanChange.intteacher,0!=o&&(n+=(o>0?"增加":"减少")+" 学生数 :"+Math.abs(o)+"<br>"),0!=l&&(n+=(l>0?"增加":"减少")+" 教师数 :"+Math.abs(l)+"<br>")):n="none",$("#historytable table tbody").append("<tr><td>"+(a+1)+"</td><td>"+t[a].operation.stroperationname+"</td><td>"+n.trimEnd("<br>")+"</td><td>"+unix2human(t[a].datecreatetime)+"</td></tr>")})}})}}$(function(){var t,a;$("#SearchDate").datepicker({format:"yyyy-mm-dd",todayBtn:"linked",autoclose:!0,todayHighlight:!0,clearBtn:!0}),$.ajax({url:"Plan/GetCourseType",dataType:"json",type:"post"}).success(function(t){for(var a=0;len=t.length,a<len;a++)$("#CourseType").append('<option value="'+t[a].intcoursetypeid+'">'+t[a].strcoursename+"</option>")}),$.ajax({url:"Plan/GetBookPlanStatus",dataType:"json",type:"post"}).success(function(t){for(var a=0;len=t.length,a<len;a++)$("#PlanStatus").append('<option value="'+t[a].intplanstatusid+'">'+t[a].strmark+"</option>")}),t=$("#datatable_perplaninfo").attr("data-size"),(void 0==t||""==t)&&(t=10),cellwidth=($(".box-content.table-responsive").width()-55)/10,a=$("#datatable_perplaninfo"),a.datagrid({striped:!0,remoteSort:!1,fit:!1,url:"Plan/GetPerPlan",loadMsg:"请等待数据载入.....",pagination:!0,rownumbers:!0,singleSelect:!0,fitColumns:!0,pageSize:t,pageList:[t,2*t,3*t,4*t,5*t],columns:[[{field:"strcoursename",title:"课程名",align:"center",sortable:!0,width:cellwidth},{field:"courseType",title:"课程类型",align:"center",width:cellwidth,sortable:!0,formatter:function(t){return t.strcoursename}},{field:"strclass",title:"班级",align:"center",width:cellwidth,sortable:!0},{field:"intstudcount",title:"学生数",align:"center",width:.5*cellwidth,sortable:!0},{field:"intteaccount",title:"教师数",align:"center",width:.5*cellwidth,sortable:!0},{field:"book",title:"书名",align:"center",width:2*cellwidth,sortable:!0,formatter:function(t){return t.strbookname}},{field:"intfromyear",title:"学年",align:"center",width:cellwidth,formatter:function(t,a){return t+"-"+a.inttoyear}},{field:"intterm",title:"学期",align:"center",width:cellwidth,sortable:!0,formatter:function(t){return t?"下半学年":"上半学年"}},{field:"strmark",title:"备注",align:"center",width:cellwidth},{field:"datecreatetime",title:"申请时间",align:"center",width:cellwidth+35,sortable:!0,formatter:function(t){return unix2human(t)}},{field:"bookPlanStatus",title:"状态",align:"center",width:cellwidth,sortable:!0,formatter:function(t){return t.strmark}}]],onBeforeLoad:function(t){t=getSearchParams(t)},toolbar:[{text:"更改计划",iconCls:"fa fa-pencil",handler:function(){toolBarClick(1)}},"-",{text:"取消计划",iconCls:"fa fa-remove",handler:function(){toolBarClick(2)}},"-",{text:"再次提交",iconCls:"fa fa-recycle",handler:function(){toolBarClick(3)}},"-",{text:"查询历史",iconCls:"fa fa-search",handler:function(){toolBarClick(4)}},"-",{text:"导出数据到Excel",iconCls:"fa fa-download",handler:function(){$.DownloadFile({url:"Plan/ExportPerPlan",method:"post",data:getSearchParams()})}}]}),$("#Search").click(function(){a.datagrid("reload")})});