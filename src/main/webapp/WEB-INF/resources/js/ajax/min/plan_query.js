function getSearchParams(params){var searchParams=new Object;return void 0!=params&&(searchParams=params),$(".SearchForm").each(function(){var param=$(this).val().trim();void 0==param&&(param=""),searchParams[$(this).attr("id")]=param}),searchParams}function toolBarClick(type){var planId,rows=$("#datatable_perplaninfo").datagrid("getSelections");if(1!=rows.length)return void $.TeachDialog({content:"You should select one row at most!",bootstrapModalOption:{}});switch(planId=rows[0].intplanid,type){case 1:if(rows[0].bookPlanStatus.intplanstatusid>2)return void $.TeachDialog({content:"The Plan can not be changed because it's status is "+rows[0].bookPlanStatus.strmark+"!",bootstrapModalOption:{}});LoadModel("changeplandetailmodel").done(function(responseContent){$.TeachDialog({title:"Change The Plan",content:responseContent,otherButtons:["Submit"],otherButtonStyles:["btn btn-primary"],dialogShow:function(){$("#StuChange,#TeaChange").TouchSpin({min:-100,max:100,step:1})},clickButton:function(sender,modal,index){if(0==index){if("0"==$("#StuChange").val()&&"0"==$("#TeaChange").val()||""==$("#StuChange").val().trim()||""==$("#TeaChange").val().trim())return void $.TeachDialog({content:"Parameters are not correct!"});$.ajax({url:"Plan/Change",dataType:"json",type:"post",data:{StuChange:$("#StuChange").val(),TeaChange:$("#TeaChange").val(),ChangeReason:$("#ChangeReason").val(),PlanId:planId}}).success(function(data){data?($.TeachDialog({content:"Changes Saved!"}),modal.modal("hide"),$("#datatable_perplaninfo").datagrid("reload")):$.TeachDialog({content:"Changes failed!"})})}}})});break;case 2:if(rows[0].bookPlanStatus.intplanstatusid>2)return void $.TeachDialog({content:"The Plan can not be canceled because it's status is "+rows[0].bookPlanStatus.strmark+"!",bootstrapModalOption:{}});$.ajax({url:"Plan/Cancel",dataType:"json",type:"post",data:{PlanId:planId}}).success(function(data){data&&($.TeachDialog({content:"The Plan has been canceled!",bootstrapModalOption:{}}),$("#datatable_perplaninfo").datagrid("reload"))});break;case 3:if(2!=rows[0].bookPlanStatus.intplanstatusid)return void $.TeachDialog({content:"The Plan can not be re-submitted because it's status is "+rows[0].bookPlanStatus.strmark+"!",bootstrapModalOption:{}});$.ajax({url:"Plan/ReSubmit",dataType:"json",type:"post",data:{PlanId:planId}}).success(function(data){data&&($.TeachDialog({content:"The Plan has been canceled!",bootstrapModalOption:{}}),$("#datatable_perplaninfo").datagrid("reload"))});break;case 4:$.TeachDialog({title:"The Plan History",content:'<div id="historytable" class="table-responsive"><table class="table"><caption>Plan Histroy Changes</caption></table></div>',dialogShow:function(){$.ajax({url:"Plan/GetPerPlanHistory",dataType:"json",type:"post",data:{PlanId:planId}}).success(function(data){var i,len,changeString,stcount,teacount;for($("#historytable table").append("<thead><tr><th>Id</th><th>Operation Name</th><th>Changes</th><th>Operation Time</th></tr></thead><tbody></tbody>"),i=0,len=data.length;len>i;i++)changeString="",data[i].bookPlanChange&&-1!=data[i].bookPlanChange.intbookchangeid?(stcount=data[i].bookPlanChange.intstudent,teacount=data[i].bookPlanChange.intteacher,0!=stcount&&(changeString+=(stcount>0?"Increase":"Decrease")+" Student Number :"+Math.abs(stcount)+"<br>"),0!=teacount&&(changeString+=(teacount>0?"Increase":"Decrease")+" Teacher Number :"+Math.abs(teacount)+"<br>")):changeString="none",$("#historytable table tbody").append("<tr><td>"+(i+1)+"</td><td>"+data[i].operation.stroperationname+"</td><td>"+changeString.trimEnd("<br>")+"</td><td>"+unix2human(data[i].datecreatetime)+"</td></tr>")})}})}}$(function(){var psval,$mydatagrid;$("#SearchDate").datepicker({format:"yyyy-mm-dd",todayBtn:"linked",autoclose:!0,todayHighlight:!0,clearBtn:!0}),$.ajax({url:"Plan/GetCourseType",dataType:"json",type:"post"}).success(function(data){for(var i=0;len=data.length,i<len;i++)$("#CourseType").append('<option value="'+data[i].intcoursetypeid+'">'+data[i].strcoursename+"</option>")}),$.ajax({url:"Plan/GetBookPlanStatus",dataType:"json",type:"post"}).success(function(data){for(var i=0;len=data.length,i<len;i++)$("#PlanStatus").append('<option value="'+data[i].intplanstatusid+'">'+data[i].strmark+"</option>")}),psval=$("#datatable_perplaninfo").attr("data-size"),(void 0==psval||""==psval)&&(psval=10),cellwidth=($(".box-content.table-responsive").width()-55)/10,$mydatagrid=$("#datatable_perplaninfo"),$mydatagrid.datagrid({striped:!0,remoteSort:!1,fit:!1,url:"Plan/GetPerPlan",loadMsg:"Please waiting for loading date.....",pagination:!0,rownumbers:!0,singleSelect:!0,fitColumns:!0,pageSize:psval,pageList:[psval,2*psval,3*psval,4*psval,5*psval],columns:[[{field:"strcoursename",title:"CourseName",align:"center",sortable:!0,width:cellwidth},{field:"courseType",title:"CourseType",align:"center",width:cellwidth,sortable:!0,formatter:function(value){return value.strcoursename}},{field:"strclass",title:"ClassId",align:"center",width:cellwidth,sortable:!0},{field:"intstudcount",title:"Student Count",align:"center",width:.5*cellwidth,sortable:!0},{field:"intteaccount",title:"Teacher Count",align:"center",width:.5*cellwidth,sortable:!0},{field:"book",title:"BookName",align:"center",width:2*cellwidth,sortable:!0,formatter:function(value){return value.strbookname}},{field:"intfromyear",title:"Time",align:"center",width:cellwidth,formatter:function(value,row){return value+"-"+row.inttoyear}},{field:"intterm",title:"Term",align:"center",width:cellwidth,sortable:!0,formatter:function(value){return value?"下半学年":"上半学年"}},{field:"strmark",title:"Mark",align:"center",width:cellwidth},{field:"datecreatetime",title:"CreateTime",align:"center",width:cellwidth+35,sortable:!0,formatter:function(value){return unix2human(value)}},{field:"bookPlanStatus",title:"Status",align:"center",width:cellwidth,sortable:!0,formatter:function(value){return value.strmark}}]],onBeforeLoad:function(param){param=getSearchParams(param)},toolbar:[{text:"Change",iconCls:"fa fa-pencil",handler:function(){toolBarClick(1)}},"-",{text:"Cancel",iconCls:"fa fa-remove",handler:function(){toolBarClick(2)}},"-",{text:"Re-Submit",iconCls:"fa fa-recycle",handler:function(){toolBarClick(3)}},"-",{text:"Query History Changes",iconCls:"fa fa-search",handler:function(){toolBarClick(4)}},"-",{text:"Export Below Plan To Excel",iconCls:"fa fa-download",handler:function(){$.DownloadFile({url:"Plan/ExportPerPlan",method:"post",data:getSearchParams()})}}]}),$("#Search").click(function(){$mydatagrid.datagrid("reload")})});