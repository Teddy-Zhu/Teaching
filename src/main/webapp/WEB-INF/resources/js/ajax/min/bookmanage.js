function setVal(e,t){$("#editCode"+e).val(t.strbookcoding),$("#editName"+e).val(t.strbookname),$("#editSN"+e).val(t.strbooksn),$("#editPress"+e).val(t.strpress),$("#editAuthor"+e).val(t.strauthor),$("#editPrice"+e).val(t.strprice),$("#editDisCount"+e).val(t.intpricediscount),initBookType("editBookType"+e,void 0).done(function(){$("#editBookType"+e).val(t.bookType.intbooktypeid)}),initSupplierType("editSupplierType"+e,void 0).done(function(){$("#editSupplierType"+e).val(t.supplier.intsupplierid)})}function initBookType(e,t){var o=$.Deferred(),i=function(i){$("#"+e).empty(),void 0!=t&&$("#"+e).append('<option value="-1">全部</option>');for(var n=0;len=i.length,n<len;n++)$("#"+e).append('<option value="'+i[n].intbooktypeid+'">'+i[n].strbooktypename+"</option>");o.resolve()};return void 0!=$("#operationpanel").data("booktype")?i($("#operationpanel").data("booktype")):$.ajax({url:"Type/GetBookType",dataType:"json",type:"post",async:!0}).success(function(e){$("#operationpanel").data("booktype",e),i(e)}),o.promise()}function initSupplierType(e,t){var o=$.Deferred(),i=function(i){$("#"+e).empty(),void 0!=t&&$("#"+e).append('<option value="-1">全部</option>');for(var n=0;len=i.length,n<len;n++)$("#"+e).append('<option value="'+i[n].intsupplierid+'">'+i[n].strname+"</option>");o.resolve()};return void 0!=$("#operationpanel").data("suppliertype")?i($("#operationpanel").data("suppliertype")):$.ajax({url:"Type/GetSupplierType",dataType:"json",type:"post",success:function(e){$("#operationpanel").data("suppliertype",e),i(e)}}),o.promise()}function getSearchParams(e){var t=new Object;return void 0!=e&&(t=e),$(".SearchForm").each(function(){var e=$(this).val().trim();void 0==e&&(e=""),t[$(this).attr("id")]=e}),t}var htmltmp=$("#newformRange").html();$(function(){$("button.editbook").click(function(){var e,t,o=$("#datatable_bookinfo").datagrid("getSelections");if(0==o.length)return void $.TeachDialog({content:"你需要选择一行 !",bootstrapModalOption:{}});for($("#bookEditTable").html(""),$("#editbookcontainer .tab-content").html(""),$("#editerrormsg").html(""),e=0;e<o.length;e++)t=o[e].intbookid,$("#bookEditTable").append('<li role="presentation"><a href="#editpanel'+t+'" role="tab" data-toggle="tab">'+o[e].strbookname+"</a></li>"),$("#editbookcontainer .tab-content").append('<div role="tabpanel" class="tab-pane fade" id="editpanel'+t+'"></div>'),$("#editpanel"+t).html(htmltmp.replace("newCode","editCode"+t).replace("newName","editName"+t).replace("newSN","editSN"+t).replace("newBookType","editBookType"+t).replace("newPress","editPress"+t).replace("newAuthor","editAuthor"+t).replace("newPrice","editPrice"+t).replace("newDisCount","editDisCount"+t).replace("newSupplierType","editSupplierType"+t).replace(new RegExp("newform","gm"),"editform")),setVal(t,o[e]);$("#bookEditTable a:first").tab("show"),$("#editbookcontainer").slideDown(),$("#operationpanel").slideUp()}),$("button.submitAdd").click(function(){var e={},t=!0;$(".newform").each(function(){return""==$(this).val().trim()?($("#adderrormsg").html("请输入 "+$(this).prev().html()+"!"),t=!1,!1):void(e[$(this).attr("id")]=$(this).val().trim())}),t&&$.ajax({url:"Book/AddBook",dataType:"json",type:"post",data:e,success:function(e){$.TeachDialog(e?{content:"添加成功，你要继续添加吗 ?",showCloseButtonName:"No",otherButtons:["确认","确认 且保持值"],bootstrapModalOption:{},CloseButtonAddFunc:function(){$("#operationpanel").slideToggle(),$("#addnewbook").slideToggle(),$("#datatable_bookinfo").datagrid("reload")},clickButton:function(e,t,o){(0==o||1==o)&&0==o&&($(".newform").val(""),$("#newBookType").get(0).selectedIndex=0,$("#newSupplierType").get(0).selectedIndex=0),$("#datatable_bookinfo").datagrid("reload"),t.modal("hide")}}:{content:"添加失败!"})}})}),$("button.cancelAdd").click(function(){$(".newform").val(""),$("#operationpanel").slideDown(),$("#addnewbook").slideUp()}),$("button.addbook").click(function(){$(".newform").val(""),initBookType("newBookType",void 0),initSupplierType("newSupplierType",void 0),$("#adderrormsg").html(""),$("#operationpanel").slideUp(),$("#addnewbook").slideDown()}),$("button.cancelEdit").click(function(){$("#operationpanel").slideDown(),$("#editbookcontainer").slideUp(),$("#bookEditTable").html(""),$("#editbookcontainer .tab-content").html("")}),$("button.submitEdit").click(function(){var e,t,o=new Array;if($("[id^=editCode]").each(function(){var e=$(this).attr("id");o.push(e.substring(8,e.length))}),e={},0!=o.length){if(t=!0,$(".editform").each(function(){return""==$(this).val().trim()?($("#editerrormsg").html("请输入 "+$(this).prev().html()+"!"),t=!1,!1):void(e[$(this).attr("id")]=$(this).val().trim())}),!t)return;e.bookId=o,$.ajax({url:"Book/EditBook",type:"post",dataType:"json",data:e,success:function(e){$.TeachDialog(e?{content:"编辑成功!",CloseButtonAddFunc:function(){$("#operationpanel").slideToggle(),$("#editbookcontainer").slideToggle(),$("#datatable_bookinfo").datagrid("reload")}}:{content:"编辑失败!",CloseButtonAddFunc:function(){$("#operationpanel").slideToggle(),$("#editbookcontainer").slideToggle(),$("#datatable_bookinfo").datagrid("reload")}})}})}}),$("button.removebook").click(function(){var e,t,o,i,n=$("#datatable_bookinfo").datagrid("getSelections");if(0==n.length)return void $.TeachDialog({content:"你至少要选择一行",bootstrapModalOption:{}});for(e=new Array,t=new Array,o=0;o<n.length;o++)e.push(parseInt(n[o].intbookid)),t.push(n[o].strbookname);i=function(){var e=$.Deferred();return $.TeachDialog({content:"你确定要删除书籍 :"+t+" ?",showCloseButtonName:"取消",otherButtons:["确认"],CloseButtonAddFunc:function(){e.reject()},clickButton:function(t,o,i){0==i&&e.resolve(),o.modal("hide")}}),e.promise()},i().done(function(){$.ajax({url:"Book/RemoveBook",type:"post",dataType:"json",data:{bookId:e},success:function(e){var t,o;if(e===!0)$.TeachDialog({content:"删除成功!"}),$("#datatable_bookinfo").datagrid("reload");else if(isNaN(e))$.TeachDialog({content:"删除失败!"});else{for(t="",o=0;o<n.length;o++)if(parseInt(n[o].intbookid)==parseInt(e)){t=n[o].strbookname;break}$.TeachDialog({content:"删除失败! 书籍:"+t+" 被使用中."})}},async:!0})})}),$("#SearchDate").datepicker({format:"yyyy-mm-dd",todayBtn:"linked",autoclose:!0,todayHighlight:!0,clearBtn:!0});var e=$("#datatable_bookinfo").attr("data-size");(void 0==e||""==e)&&(e=10),initBookType("SearchType","type"),initSupplierType("SearchSupplier","type"),cellwidth=($(".box-content.table-responsive").width()-55)/11,$("#datatable_bookinfo").datagrid({striped:!0,remoteSort:!1,collapsible:!0,fit:!1,url:"Book/GetBooks",loadMsg:"请等待数据载入....",pagination:!0,rownumbers:!0,fitColumns:!0,pageSize:e,pageList:[e,2*e,3*e,4*e,5*e],columns:[[{field:"strbookcoding",title:"编号",align:"center",sortable:!0,width:cellwidth},{field:"strbookname",title:"书名",align:"center",width:cellwidth,sortable:!0},{field:"strbooksn",title:"SN号",align:"center",width:cellwidth,sortable:!0},{field:"bookType",title:"类型",align:"center",width:cellwidth,sortable:!0,formatter:function(e){return e.strbooktypename}},{field:"strpress",title:"出版社",align:"center",width:cellwidth,sortable:!0},{field:"strauthor",title:"作者",align:"center",width:cellwidth,sortable:!0},{field:"supplier",title:"供应商",align:"center",width:cellwidth,sortable:!0,formatter:function(e){return e.strname}},{field:"strprice",title:"单价",align:"center",width:cellwidth,sortable:!0},{field:"intpricediscount",title:"折扣",align:"center",width:cellwidth,sortable:!0},{field:"dateaddtime",title:"录入时间",align:"center",width:cellwidth+35,sortable:!0,formatter:function(e){return unix2human(e)}}]],onBeforeLoad:function(e){e=getSearchParams(e)}}),$("#Search").click(function(){$("#datatable_bookinfo").datagrid("reload")})});