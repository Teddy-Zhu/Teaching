function setVal(id,obj){$("#editUserName"+id).val(obj.username),$("#editPassword"+id).val("[%keep%]"),$("#editRealName"+id).val(obj.strname),$("#editNumber"+id).val(obj.strstunum),$("#editEmail"+id).val(obj.strmail),$("#editPhone"+id).val(obj.strphone),initUserType("editType"+id).done(function(){$("#editType"+id).val(obj.userType.intidentityid)}),initUserDepartMent("editDepartMent"+id,1).done(function(){$("#editDepartMent"+id).change(function(){initUserDepartMent("editMajor"+id,$("#editDepartMent"+id).val())}),$("#editDepartMent"+id).val(obj.userDepartMent.intid),initUserDepartMent("editMajor"+id,$("#editDepartMent"+id).val()).done(function(){$("#editMajor"+id).val(obj.userMajor.intid)})})}function initUserType(id,addition){var dtd=$.Deferred(),fillDom=function(domData){$("#"+id).empty(),void 0!=addition&&$("#"+id).append('<option value="-1">All UserType</option>');for(var i=0;len=domData.length,i<len;i++)$("#"+id).append('<option value="'+domData[i].intidentityid+'">'+domData[i].strname+"</option>");dtd.resolve()};return void 0!=$("#operationpanel").data("usertype")?fillDom($("#operationpanel").data("usertype")):$.ajax({url:"Type/GetUserTypeAll",dataType:"json",type:"post",success:function(data){$("#operationpanel").data("usertype",data),fillDom(data)},async:!0}),dtd.promise()}function getSearchParams(params){var searchParams=new Object;return void 0!=params&&(searchParams=params),$(".SearchForm").each(function(){var param=$(this).val().trim();void 0==param&&(param=""),searchParams[$(this).attr("id")]=param}),searchParams}function initUserDepartMent(id,type,addition){var typedata=type.toString().replace("-","minus"),dtd=$.Deferred(),filldom=function(domData){$("#"+id).empty(),void 0!=addition&&$("#"+id).append('<option value="-1">All DepartMent</option>');for(var i=0;len=domData.length,i<len;i++)$("#"+id).append('<option value="'+domData[i].intid+'">'+domData[i].strname+"</option>");dtd.resolve()};return void 0!=$("#operationpanel").data("userdepartment"+typedata)?filldom($("#operationpanel").data("userdepartment"+typedata)):$.ajax({url:"Type/GetDepartMent",type:"post",dataType:"json",data:{id:type},success:function(data){$("#operationpanel").data("userdepartment"+typedata,data),filldom(data)},async:!0}),dtd.promise()}var htmltmp=$("#newformRange").html();$(function(){var psval,cellwidth;$("#newDepartMent").change(function(){initUserDepartMent("newMajor",$(this).val())}),$("#SearchTime").datepicker({format:"yyyy-mm-dd",todayBtn:"linked",autoclose:!0,todayHighlight:!0,clearBtn:!0}),psval=$("#datatable_userinfo").attr("data-size"),(void 0==psval||""==psval)&&(psval=10),cellwidth=($(".box-content.table-responsive").width()-55)/11,$("#datatable_userinfo").datagrid({striped:!0,remoteSort:!1,collapsible:!0,fit:!1,url:"User/GetAllUser",loadMsg:"Please waiting for loading date.....",pagination:!0,rownumbers:!0,fitColumns:!0,pageSize:psval,pageList:[psval,2*psval,3*psval,4*psval,5*psval],columns:[[{field:"intid",title:"User ID",align:"center",sortable:!0,width:.5*cellwidth},{field:"username",title:"UserName",align:"center",sortable:!0,width:cellwidth},{field:"strname",title:"RealName",align:"center",width:cellwidth,sortable:!0},{field:"userType",title:"UserType",align:"center",width:cellwidth,sortable:!0,formatter:function(value){return value.strname}},{field:"userDepartMent",title:"DepartMent",align:"center",width:cellwidth,sortable:!0,formatter:function(value){return value.strname}},{field:"userMajor",title:"Major",align:"center",width:1.4*cellwidth,sortable:!0,formatter:function(value){return value.strname}},{field:"strstunum",title:"Id Card",align:"center",width:cellwidth,sortable:!0},{field:"strphone",title:"Phone",align:"center",width:cellwidth,sortable:!0},{field:"strmail",title:"Email",align:"center",width:cellwidth,sortable:!0},{field:"dateregtime",title:"CreateTime",align:"center",width:1.1*cellwidth+10,sortable:!0,formatter:function(value){return unix2human(value)}}]],onBeforeLoad:function(param){param=getSearchParams(param)}}),initUserType("SearchUserType",!0),initUserDepartMent("SearchDepartMent",1,!0).done(function(){$("#SearchDepartMent").change(function(){initUserDepartMent("SearchMajor",$("#SearchDepartMent").val(),!0)}),initUserDepartMent("SearchMajor",$("#SearchDepartMent").val(),!0)}),$("button.adduser").click(function(){initUserType("newType"),initUserDepartMent("newDepartMent",1).done(function(){initUserDepartMent("newMajor",$("#newDepartMent").val())}),$("input.newform").val(""),$("#adderrormsg").html(""),$("#operationpanel").slideUp(),$("#addnewuser").slideDown()}),$("button.submitAdd").click(function(){var postdata={},check=!0;$(".newform").each(function(){return""==$(this).val().trim()?($("#adderrormsg").html("please input "+$(this).prev().html()+"!"),check=!1,!1):void(postdata[$(this).attr("id")]=$(this).val().trim())}),check&&$.ajax({url:"User/AuthRegisterAdmin",dataType:"json",type:"post",data:postdata,success:function(response){$.TeachDialog(response?{title:"Operation Message!",content:"Add a new User successfully and do you want to add more ?",showCloseButtonName:"No",otherButtons:["Yes","Yes & Keep Val"],CloseButtonAddFunc:function(){$("#operationpanel").slideToggle(),$("#addnewuser").slideToggle(),$("#datatable_userinfo").datagrid("reload")},clickButton:function(sender,modal,index){(0==index||1==index)&&0==index&&($(".newform").val(""),$("#newType").get(0).selectedIndex=0,$("#newDepartMent").get(0).selectedIndex=0,initUserDepartMent("newMajor",$("#newDepartMent").val())),$("#datatable_userinfo").datagrid("reload"),modal.modal("hide")}}:{content:"Add User Failed!"})}})}),$("button.cancelAdd").click(function(){$("#addnewuser").slideUp(),$("#operationpanel").slideDown()}),$("button.edituser").click(function(){var i,id,rows=$("#datatable_userinfo").datagrid("getSelections");if(0==rows.length)return void $.TeachDialog({content:"You should select one row at least !",bootstrapModalOption:{}});for($("#userEditTable").html(""),$("#editusercontainer .tab-content").html(""),$("#editerrormsg").html(""),i=0;i<rows.length;i++)id=rows[i].intid,$("#userEditTable").append('<li role="presentation"><a href="#editpanel'+id+'" role="tab" data-toggle="tab">'+rows[i].username+"</a></li>"),$("#editusercontainer .tab-content").append('<div role="tabpanel" class="tab-pane fade" id="editpanel'+id+'"></div>'),$("#editpanel"+id).html(htmltmp.replace("newUserName","editUserName"+id).replace("newPassword","editPassword"+id).replace("newRealName","editRealName"+id).replace("newType","editType"+id).replace("newNumber","editNumber"+id).replace("newEmail","editEmail"+id).replace("newPhone","editPhone"+id).replace("newDepartMent","editDepartMent"+id).replace("newMajor","editMajor"+id).replace(new RegExp("newform","gm"),"editform")),setVal(id,rows[i]);$("#userEditTable a:first").tab("show"),$("#editusercontainer").slideDown(),$("#operationpanel").slideUp()}),$("button.submitEdit").click(function(){var postdata,check,idarray=new Array;if($("[id^=editUserName]").each(function(){var l=$(this).attr("id");idarray.push(l.substring(12,l.length))}),postdata={},0!=idarray.length){if(check=!0,$(".editform").each(function(){return""==$(this).val().trim()?($("#editerrormsg").html("please input "+$(this).prev().html()+"!"),check=!1,!1):void(postdata[$(this).attr("id")]=$(this).val().trim())}),!check)return;postdata.userId=idarray,$.ajax({url:"User/UpdateUserInfoAdmin",type:"post",dataType:"json",data:postdata,success:function(data){$.TeachDialog(data?{title:"Operation Message!",content:"Edit Users Info successfully!",CloseButtonAddFunc:function(){$("#operationpanel").slideDown(),$("#editusercontainer").slideUp(),$("#datatable_userinfo").datagrid("reload")}}:{title:"Operation Message!",content:"Edit Users Info failed!",CloseButtonAddFunc:function(){$("#operationpanel").slideDown(),$("#editusercontainer").slideUp(),$("#datatable_userinfo").datagrid("reload")}})}})}}),$("button.cancelEdit").click(function(){$("#operationpanel").slideDown(),$("#editusercontainer").slideUp()}),$("button.removeuser").click(function(){var userIdArray,namesArray,i,sureDialog,rows=$("#datatable_userinfo").datagrid("getSelections");if(0==rows.length)return void $.TeachDialog({content:"You should select one row at least !",bootstrapModalOption:{}});for(userIdArray=new Array,namesArray=new Array,i=0;i<rows.length;i++)userIdArray.push(parseInt(rows[i].intid)),namesArray.push(rows[i].username);sureDialog=function(){var dtd=$.Deferred();return $.TeachDialog({title:"Warnning Message!",content:"Are you sure remove this users :"+namesArray+" ?",showCloseButtonName:"No",otherButtons:["Yes"],CloseButtonAddFunc:function(){dtd.reject()},clickButton:function(sender,modal,index){0==index&&dtd.resolve(),modal.modal("hide")}}),dtd.promise()},sureDialog().done(function(){$.ajax({url:"User/RemoveUser",type:"post",dataType:"json",data:{userId:userIdArray},success:function(response){var username,i;if(response===!0)$.TeachDialog({title:"Operation Message!",content:"Remove users successfully!"}),$("#datatable_userinfo").datagrid("reload");else if(isNaN(response))$.TeachDialog({content:"Remove users failed!"});else{for(username="",i=0;i<rows.length;i++)if(parseInt(rows[i].intid)==parseInt(response)){username=rows[i].username;break}$.TeachDialog({content:"Remove users failed! User:"+username+" in use."})}},async:!0})}).fail(function(){})}),$("#Search").click(function(){$("#datatable_userinfo").datagrid("reload")})});