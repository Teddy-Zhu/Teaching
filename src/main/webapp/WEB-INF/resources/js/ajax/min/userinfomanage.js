function setVal(e,t){$("#editUserName"+e).val(t.username),$("#editPassword"+e).val("[%keep%]"),$("#editRealName"+e).val(t.strname),$("#editNumber"+e).val(t.strstunum),$("#editEmail"+e).val(t.strmail),$("#editPhone"+e).val(t.strphone),initUserType("editType"+e).done(function(){$("#editType"+e).val(t.userType.intidentityid)}),initUserDepartMent("editDepartMent"+e,1).done(function(){$("#editDepartMent"+e).change(function(){initUserDepartMent("editMajor"+e,$("#editDepartMent"+e).val())}),$("#editDepartMent"+e).val(t.userDepartMent.intid),initUserDepartMent("editMajor"+e,$("#editDepartMent"+e).val()).done(function(){$("#editMajor"+e).val(t.userMajor.intid)})})}function initUserType(e,t){var n=$.Deferred(),a=function(a){$("#"+e).empty(),void 0!=t&&$("#"+e).append('<option value="-1">全部</option>');for(var r=0;len=a.length,r<len;r++)$("#"+e).append('<option value="'+a[r].intidentityid+'">'+a[r].strname+"</option>");n.resolve()};return void 0!=$("#operationpanel").data("usertype")?a($("#operationpanel").data("usertype")):$.ajax({url:"Type/GetUserTypeAll",dataType:"json",type:"post",success:function(e){$("#operationpanel").data("usertype",e),a(e)},async:!0}),n.promise()}function getSearchParams(e){var t=new Object;return void 0!=e&&(t=e),$(".SearchForm").each(function(){var e=$(this).val().trim();void 0==e&&(e=""),t[$(this).attr("id")]=e}),t}function initUserDepartMent(e,t,n){var a=t.toString().replace("-","minus"),r=$.Deferred(),i=function(t){$("#"+e).empty(),void 0!=n&&$("#"+e).append('<option value="-1">全部</option>');for(var a=0;len=t.length,a<len;a++)$("#"+e).append('<option value="'+t[a].intid+'">'+t[a].strname+"</option>");r.resolve()};return void 0!=$("#operationpanel").data("userdepartment"+a)?i($("#operationpanel").data("userdepartment"+a)):$.ajax({url:"Type/GetDepartMent",type:"post",dataType:"json",data:{id:t},success:function(e){$("#operationpanel").data("userdepartment"+a,e),i(e)},async:!0}),r.promise()}var htmltmp=$("#newformRange").html();$(function(){var e,t;$("#newDepartMent").change(function(){initUserDepartMent("newMajor",$(this).val())}),$("#SearchTime").datepicker({format:"yyyy-mm-dd",todayBtn:"linked",autoclose:!0,todayHighlight:!0,clearBtn:!0}),e=$("#datatable_userinfo").attr("data-size"),(void 0==e||""==e)&&(e=10),t=($(".box-content.table-responsive").width()-55)/11,$("#datatable_userinfo").datagrid({striped:!0,remoteSort:!1,collapsible:!0,fit:!1,url:"User/GetAllUser",loadMsg:"请等待数据载入.....",pagination:!0,rownumbers:!0,fitColumns:!0,pageSize:e,pageList:[e,2*e,3*e,4*e,5*e],columns:[[{field:"intid",title:"ID",align:"center",sortable:!0,width:.5*t},{field:"username",title:"用户名",align:"center",sortable:!0,width:t},{field:"strname",title:"姓名",align:"center",width:t,sortable:!0},{field:"userType",title:"用户类型",align:"center",width:t,sortable:!0,formatter:function(e){return e.strname}},{field:"userDepartMent",title:"系部",align:"center",width:t,sortable:!0,formatter:function(e){return e.strname}},{field:"userMajor",title:"专业",align:"center",width:1.4*t,sortable:!0,formatter:function(e){return e.strname}},{field:"strstunum",title:"学号",align:"center",width:t,sortable:!0},{field:"strphone",title:"手机",align:"center",width:t,sortable:!0},{field:"strmail",title:"邮箱",align:"center",width:t,sortable:!0},{field:"dateregtime",title:"创建时间",align:"center",width:1.1*t+10,sortable:!0,formatter:function(e){return unix2human(e)}}]],onBeforeLoad:function(e){e=getSearchParams(e)}}),initUserType("SearchUserType",!0),initUserDepartMent("SearchDepartMent",1,!0).done(function(){$("#SearchDepartMent").change(function(){initUserDepartMent("SearchMajor",$("#SearchDepartMent").val(),!0)}),initUserDepartMent("SearchMajor",$("#SearchDepartMent").val(),!0)}),$("button.adduser").click(function(){initUserType("newType"),initUserDepartMent("newDepartMent",1).done(function(){initUserDepartMent("newMajor",$("#newDepartMent").val())}),$("input.newform").val(""),$("#adderrormsg").html(""),$("#operationpanel").slideUp(),$("#addnewuser").slideDown()}),$("button.submitAdd").click(function(){var e={},t=!0;$(".newform").each(function(){return""==$(this).val().trim()?($("#adderrormsg").html("请输入 "+$(this).prev().html()+"!"),t=!1,!1):void(e[$(this).attr("id")]=$(this).val().trim())}),t&&$.ajax({url:"User/AuthRegisterAdmin",dataType:"json",type:"post",data:e,success:function(e){$.TeachDialog(e?{content:"添加用户成功，你需要继续吗 ?",showCloseButtonName:"取消",otherButtons:["确认","确认且保存值"],CloseButtonAddFunc:function(){$("#operationpanel").slideToggle(),$("#addnewuser").slideToggle(),$("#datatable_userinfo").datagrid("reload")},clickButton:function(e,t,n){(0==n||1==n)&&0==n&&($(".newform").val(""),$("#newType").get(0).selectedIndex=0,$("#newDepartMent").get(0).selectedIndex=0,initUserDepartMent("newMajor",$("#newDepartMent").val())),$("#datatable_userinfo").datagrid("reload"),t.modal("hide")}}:{content:"添加用户失败!"})}})}),$("button.cancelAdd").click(function(){$("#addnewuser").slideUp(),$("#operationpanel").slideDown()}),$("button.edituser").click(function(){var e,t,n=$("#datatable_userinfo").datagrid("getSelections");if(0==n.length)return void $.TeachDialog({content:"你至少需要选择一行 !",bootstrapModalOption:{}});for($("#userEditTable").html(""),$("#editusercontainer .tab-content").html(""),$("#editerrormsg").html(""),e=0;e<n.length;e++)t=n[e].intid,$("#userEditTable").append('<li role="presentation"><a href="#editpanel'+t+'" role="tab" data-toggle="tab">'+n[e].username+"</a></li>"),$("#editusercontainer .tab-content").append('<div role="tabpanel" class="tab-pane fade" id="editpanel'+t+'"></div>'),$("#editpanel"+t).html(htmltmp.replace("newUserName","editUserName"+t).replace("newPassword","editPassword"+t).replace("newRealName","editRealName"+t).replace("newType","editType"+t).replace("newNumber","editNumber"+t).replace("newEmail","editEmail"+t).replace("newPhone","editPhone"+t).replace("newDepartMent","editDepartMent"+t).replace("newMajor","editMajor"+t).replace(new RegExp("newform","gm"),"editform")),setVal(t,n[e]);$("#userEditTable a:first").tab("show"),$("#editusercontainer").slideDown(),$("#operationpanel").slideUp()}),$("button.submitEdit").click(function(){var e,t,n=new Array;if($("[id^=editUserName]").each(function(){var e=$(this).attr("id");n.push(e.substring(12,e.length))}),e={},0!=n.length){if(t=!0,$(".editform").each(function(){return""==$(this).val().trim()?($("#editerrormsg").html("请输入 "+$(this).prev().html()+"!"),t=!1,!1):void(e[$(this).attr("id")]=$(this).val().trim())}),!t)return;e.userId=n,$.ajax({url:"User/UpdateUserInfoAdmin",type:"post",dataType:"json",data:e,success:function(e){$.TeachDialog(e?{content:"编辑用户成功!",CloseButtonAddFunc:function(){$("#operationpanel").slideDown(),$("#editusercontainer").slideUp(),$("#datatable_userinfo").datagrid("reload")}}:{content:"编辑用户失败!",CloseButtonAddFunc:function(){$("#operationpanel").slideDown(),$("#editusercontainer").slideUp(),$("#datatable_userinfo").datagrid("reload")}})}})}}),$("button.cancelEdit").click(function(){$("#operationpanel").slideDown(),$("#editusercontainer").slideUp()}),$("button.removeuser").click(function(){var e,t,n,a,r=$("#datatable_userinfo").datagrid("getSelections");if(0==r.length)return void $.TeachDialog({content:"你至少需要选择一行 !",bootstrapModalOption:{}});for(e=new Array,t=new Array,n=0;n<r.length;n++)e.push(parseInt(r[n].intid)),t.push(r[n].username);a=function(){var e=$.Deferred();return $.TeachDialog({content:"你确定要删除用户 :"+t+" ?",showCloseButtonName:"No",otherButtons:["Yes"],CloseButtonAddFunc:function(){e.reject()},clickButton:function(t,n,a){0==a&&e.resolve(),n.modal("hide")}}),e.promise()},a().done(function(){$.ajax({url:"User/RemoveUser",type:"post",dataType:"json",data:{userId:e},success:function(e){var t,n;if(e===!0)$.TeachDialog({content:"删除用户成功!"}),$("#datatable_userinfo").datagrid("reload");else if(isNaN(e))$.TeachDialog({content:"删除用户失败!"});else{for(t="",n=0;n<r.length;n++)if(parseInt(r[n].intid)==parseInt(e)){t=r[n].username;break}$.TeachDialog({content:"删除用户失败! 用户:"+t+" 被使用中."})}},async:!0})}).fail(function(){})}),$("#Search").click(function(){$("#datatable_userinfo").datagrid("reload")})});